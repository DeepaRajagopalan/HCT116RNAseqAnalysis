#Mapping of Data

/home/sb/programfiles/STAR/bin/Linux_x86_64/STAR --runThreadN 18 --genomeDir /home/deepa/newgenome/data/GRCh38/star_indices_overhang100 --readFilesIn /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAAARAAPEI-209_1.fq.gz /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAAARAAPEI-209_2.fq.gz --readFilesCommand zcat --outFileNamePrefix /home/deepa/G9A_Analysis/output/shC/C1 --outSAMtype BAM SortedByCoordinate

/home/sb/programfiles/STAR/bin/Linux_x86_64/STAR --runThreadN 18 --genomeDir /home/deepa/newgenome/data/GRCh38/star_indices_overhang100 --readFilesIn /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAABRAAPEI-210_1.fq.gz /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAABRAAPEI-210_2.fq.gz --readFilesCommand zcat --outFileNamePrefix /home/deepa/G9A_Analysis/output/shC/C2 --outSAMtype BAM SortedByCoordinate

/home/sb/programfiles/STAR/bin/Linux_x86_64/STAR --runThreadN 18 --genomeDir /home/deepa/newgenome/data/GRCh38/star_indices_overhang100 --readFilesIn /home/deepa/G9A_Analysis/FCHNK3WBBXX_L7_HKHUMkjvEAAERABPEI-213_1.fq.gz /home/deepa/G9A_Analysis/FCHNK3WBBXX_L7_HKHUMkjvEAAERABPEI-213_2.fq.gz --readFilesCommand zcat --outFileNamePrefix /home/deepa/G9A_Analysis/output/shB/B1 --outSAMtype BAM SortedByCoordinate 

/home/sb/programfiles/STAR/bin/Linux_x86_64/STAR --runThreadN 18 --genomeDir /home/deepa/newgenome/data/GRCh38/star_indices_overhang100 --readFilesIn /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAAFRAAPEI-214_1.fq.gz /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAAFRAAPEI-214_2.fq.gz --readFilesCommand zcat --outFileNamePrefix /home/deepa/G9A_Analysis/output/shB/B2 --outSAMtype BAM SortedByCoordinate 

/home/sb/programfiles/STAR/bin/Linux_x86_64/STAR --runThreadN 18 --genomeDir /home/deepa/newgenome/data/GRCh38/star_indices_overhang100 --readFilesIn /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAACRAAPEI-211_1.fq.gz /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAACRAAPEI-211_2.fq.gz --readFilesCommand zcat --outFileNamePrefix /home/deepa/G9A_Analysis/output/shD/D1 --outSAMtype BAM SortedByCoordinate 

/home/sb/programfiles/STAR/bin/Linux_x86_64/STAR --runThreadN 18 --genomeDir /home/deepa/newgenome/data/GRCh38/star_indices_overhang100 --readFilesIn /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAADRAAPEI-212_1.fq.gz /home/deepa/G9A_Analysis/FCHNVTNBBXX_L2_HKHUMkjvEAADRAAPEI-212_2.fq.gz --readFilesCommand zcat --outFileNamePrefix /home/deepa/G9A_Analysis/output/shD/D2 --outSAMtype BAM SortedByCoordinate 

library(Rsubread)
options(scipen=999)

data <- featureCounts(c(
"/home/deepa/G9A_Analysis/output/shC/C2Aligned.sortedByCoord.out.bam",
"/home/deepa/G9A_Analysis/output/shC/C1Aligned.sortedByCoord.out.bam",
"/home/deepa/G9A_Analysis/output/shB/B1Aligned.sortedByCoord.out.bam",
"/home/deepa/G9A_Analysis/output/shB/B2Aligned.sortedByCoord.out.bam",
"/home/deepa/G9A_Analysis/output/shD/D1Aligned.sortedByCoord.out.bam",
"/home/deepa/G9A_Analysis/output/shD/D2Aligned.sortedByCoord.out.bam"),
annot.ext="/home/deepa/Annotation/gencode.v27.annotation.gtf",
isGTFAnnotationFile=TRUE,
minMQS=10,
strandSpecific=0,
isPairedEnd=TRUE,
autosort=TRUE,
nthreads=15,
GTF.attrType="gene_name"
)

dat=data[[1]] 
saveRDS(dat,"G9A_Counts.rds")

dataset = readRDS("G9A_Counts.rds")
#DESeq2

library(DESeq2)
designG9A=data.frame(replicate=c("1","2","1","2","1","2"),condition=c("shControl","shControl","shG9A_B","shG9A_B","shG9A_D","shG9A_D"))
dds=DESeqDataSetFromMatrix(countData=dataset, colData=designG9A, design= ~replicate+condition)
#next part is to run the actual differential analysis
ddsgenes=DESeq(dds, test="LRT", full= ~replicate+condition, reduced= ~replicate)
#to extract results in a way that makes sense
dds_results=results(ddsgenes, contrast=c("condition", "shControl", "shG9A_B"))
dds_results2=results(ddsgenes, contrast=c("condition", "shControl", "shG9A_D"))
write.csv(dds_results,"G9A_B_allgenes")
write.csv(dds_results2,"G9A_D_allgenes")

#PlotPCA
ddsgenes_vst <- varianceStabilizingTransformation(ddsgenes)
plotPCA(ddsgenes_vst,ntop=30000,intgroup=c("replicate","condition"))
